<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GitHub File Upload</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body{
        font-family:Arial,Helvetica,sans-serif;
        background:#f5f7fa;
        margin:0;
        display:flex;
        justify-content:center;
        align-items:flex-start;
        min-height:100vh;
        padding-top:2rem;
    }
    .card{
        background:#fff;
        border-radius:8px;
        box-shadow:0 2px 8px rgba(0,0,0,.1);
        max-width:440px;
        width:100%;
        padding:1.5rem;
    }
    h2{margin:0 0 .8rem;font-size:1.4rem;color:#333;}
    label{display:block;margin-top:1rem;font-size:.9rem;color:#555;}
    input[type=text],
    input[type=password],
    input[type=file],
    select{
        width:100%;padding:.6rem;margin-top:.3rem;
        border:1px solid #ccc;border-radius:4px;font-size:1rem;
        box-sizing:border-box;
    }
    button{
        margin-top:1.5rem;width:100%;padding:.7rem;
        background:#0066ff;color:#fff;border:none;
        border-radius:4px;font-size:1rem;cursor:pointer;
        transition:background .2s;
    }
    button:hover{background:#0052cc;}
    .status{margin-top:1rem;padding:.6rem;border-radius:4px;display:none;}
    .status.success{background:#e6ffed;color:#0a6620;}
    .status.error{background:#ffe6e6;color:#a00;}
    /* ---- spinner ---- */
    .spinner{
        display:none;
        margin:1rem auto;
        width:40px;
        height:40px;
        border:4px solid #ccc;
        border-top-color:#0066ff;
        border-radius:50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin{
        to{transform:rotate(360deg);}
    }
</style>
</head>
<body>

<div class="card">
    <h2>Upload File to GitHub</h2>

    <label for="token">GitHub Token</label>
    <input type="password" id="token" placeholder="Personal access token">

    <label for="owner">Repository Owner</label>
    <input type="text" id="owner" placeholder="e.g. octocat">

    <label for="repo">Repository Name</label>
    <input type="text" id="repo" placeholder="e.g. hello-world">

    <label for="pathSelect">Target Path (folder)</label>
    <select id="pathSelect"></select>
    <input type="text" id="newPath" placeholder="Enter new path and press Enter">

    <label for="file">Select File</label>
    <input type="file" id="file">

    <button id="uploadBtn">Upload</button>

    <!-- spinner -->
    <div class="spinner" id="spinner"></div>

    <div id="msg" class="status"></div>
</div>

<script>
/* ---------- Helpers ---------- */
function showMessage(text, type){
    const el = document.getElementById('msg');
    el.textContent = text;
    el.className = 'status ' + (type==='error' ? 'error' : 'success');
    el.style.display = 'block';
}
function sanitiseFileName(name){
    return name.replace(/\s+/g, '_').toLowerCase();
}
function toggleSpinner(show){
    document.getElementById('spinner').style.display = show ? 'block' : 'none';
}

/* ---------- Local‑storage keys ---------- */
const TOKEN_KEY = 'ghToken';
const PATHS_KEY = 'ghPathHistory';

/* ---------- Load saved token ---------- */
const tokenInput = document.getElementById('token');
const savedToken = localStorage.getItem(TOKEN_KEY);
if (savedToken) tokenInput.value = savedToken;

/* ---------- Path history handling ---------- */
const pathSelect = document.getElementById('pathSelect');
const newPathInput = document.getElementById('newPath');

function getPathHistory(){
    const raw = localStorage.getItem(PATHS_KEY);
    return raw ? JSON.parse(raw) : [];
}
function savePathHistory(arr){
    localStorage.setItem(PATHS_KEY, JSON.stringify(arr));
}
function renderPathSelect(){
    const history = getPathHistory();
    pathSelect.innerHTML = '';
    history.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        pathSelect.appendChild(opt);
    });
    if (history.length===0){
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '-- no saved paths --';
        pathSelect.appendChild(opt);
    }
}
renderPathSelect();

newPathInput.addEventListener('keydown', e => {
    if (e.key !== 'Enter') return;
    const raw = newPathInput.value.trim().replace(/^\/|\/$/g,'');
    if (!raw) return;
    const history = getPathHistory();
    if (!history.includes(raw)){
        history.unshift(raw);
        if (history.length > 20) history.pop();
        savePathHistory(history);
        renderPathSelect();
    }
    newPathInput.value = '';
    pathSelect.value = raw;
});

/* ---------- Upload logic ---------- */
document.getElementById('uploadBtn').addEventListener('click', async () => {
    const token   = tokenInput.value.trim();
    const owner   = document.getElementById('owner').value.trim();
    const repo    = document.getElementById('repo').value.trim();
    const folder  = pathSelect.value.trim().replace(/^\/|\/$/g,'');
    const file    = document.getElementById('file').files[0];

    if (!token || !owner || !repo || !folder || !file){
        showMessage('All fields are required.', 'error');
        return;
    }

    // persist token
    localStorage.setItem(TOKEN_KEY, token);

    const safeName = sanitiseFileName(file.name);
    const repoPath = folder ? `${folder}/${safeName}` : safeName;

    console.log('Uploading:', {owner, repo, repoPath, original:file.name, safe:safeName});

    // show spinner
    toggleSpinner(true);
    showMessage('Uploading…', 'success');

    // read file as base64
    const base64 = await new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result.split(',')[1]);
        r.onerror = rej;
        r.readAsDataURL(file);
    });

    const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(repoPath)}`;

    const payload = {
        message: `Upload ${safeName} via web UI`,
        content: base64,
        branch: "main"
    };

    try{
        const resp = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        const data = await resp.json();
        console.log('Response:', resp.status, data);

        if (resp.ok){
            showMessage('✅ File uploaded successfully!', 'success');
            alert('Upload complete!\n' + JSON.stringify(data, null, 2));
        }else{
            const err = data.message || 'Unknown error';
            showMessage('❌ Upload failed: ' + err, 'error');
            alert('Error uploading file:\n' + err);
        }
    }catch(e){
        console.error('Fetch error:', e);
        showMessage('❌ Network error.', 'error');
        alert('Network error:\n' + e.message);
    }finally{
        // hide spinner regardless of outcome
        toggleSpinner(false);
    }
});
</script>

</body>
</html>
