<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload with GitHub Action</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input, select, button {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
        }
        #preview {
            max-width: 100%;
            margin-top: 10px;
            display: none;
        }
        .error {
            color: red;
            font-size: 14px;
        }
        .success {
            color: green;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Upload Image and Trigger GitHub Action</h1>
    <form id="uploadForm">
        <div class="form-group">
            <label for="image">Select Image:</label>
            <input type="file" id="image" accept="image/*" required>
            <img id="preview" alt="Image Preview">
        </div>
        <div class="form-group">
            <label for="category">Category:</label>
            <select id="category" required>
                <option value="podcasts">Podcasts</option>
                <option value="jokes">Jokes</option>
				<option value="conversations">Conversations</option>
            </select>
        </div>
        <div class="form-group">
            <label for="githubToken">GitHub Token:</label>
            <input type="password" id="githubToken" placeholder="Enter your GitHub Token">
            <label><input type="checkbox" id="saveToken"> Save token for future use</label>
        </div>
        <div class="form-group">
            <label for="webhookUrl">Webhook URL:</label>
            <input type="url" id="webhookUrl" placeholder="Enter GitHub Action Webhook URL" required>
        </div>
        <button type="submit">Upload and Trigger</button>
    </form>
    <p id="message"></p>

    <script>
        // Load saved token from localStorage
        document.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                document.getElementById('githubToken').value = savedToken;
                document.getElementById('saveToken').checked = true;
            }

            // Preview image
            document.getElementById('image').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const preview = document.getElementById('preview');
                        preview.src = reader.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Form submission
            document.getElementById('uploadForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = document.getElementById('message');
                message.textContent = '';

                const image = document.getElementById('image').files[0];
                const category = document.getElementById('category').value;
                const githubToken = document.getElementById('githubToken').value;
                const saveToken = document.getElementById('saveToken').checked;
                const webhookUrl = document.getElementById('webhookUrl').value;

                if (!image) {
                    message.textContent = 'Please select an image.';
                    message.className = 'error';
                    return;
                }

                if (!webhookUrl) {
                    message.textContent = 'Please provide a webhook URL.';
                    message.className = 'error';
                    return;
                }

                // Save or remove token from localStorage
                if (saveToken && githubToken) {
                    localStorage.setItem('githubToken', githubToken);
                } else {
                    localStorage.removeItem('githubToken');
                }

                try {
                    // Convert image to base64
                    const reader = new FileReader();
                    reader.readAsDataURL(image);
                    reader.onload = async () => {
                        const base64Image = reader.result.split(',')[1]; // Remove data:image/*;base64,

                        // Prepare payload for GitHub Action
                        const payload = {
                            ref: 'main',
                            image: base64Image,
                            category: category,
                            filename: image.name
                        };

                        // Send request to webhook
                        const response = await fetch("https://api.github.com/repos/yblebon/hooks/actions/workflows/upload-image.yml/dispatches", {
                            method: 'POST',
	                    headers: {
		                    'Content-Type': 'application/json',
		                    'Authorization': `Bearer ${githubToken}`,
		                    'Accept': 'application/vnd.github.v3+json'
		                },
	                    body: JSON.stringify({
		                    ref: 'main',
		                    inputs: {
		                        image: base64Image,
		                        category: category,
		                        filename: image.name
		                    }
		             })
                        });

                        if (response.ok) {
                            message.textContent = 'Image uploaded and GitHub Action triggered successfully!';
                            message.className = 'success';
                            document.getElementById('uploadForm').reset();
                            document.getElementById('preview').style.display = 'none';
                        } else {
                            const errorData = await response.json();
                            message.textContent = `Error: ${errorData.message || 'Failed to trigger GitHub Action.'}`;
                            message.className = 'error';
                        }
                    };
                    reader.onerror = () => {
                        message.textContent = 'Error reading the image file.';
                        message.className = 'error';
                    };
                } catch (error) {
                    message.textContent = `Error: ${error.message}`;
                    message.className = 'error';
                }
            });
        });
    </script>
</body>
</html>
